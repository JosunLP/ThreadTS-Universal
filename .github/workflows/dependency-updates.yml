name: ğŸ”„ Dependency Updates

on:
  schedule:
    # Weekly dependency updates on Mondays at 08:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:
    inputs:
      update_type:
        description: "Type of update to perform"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
          - all

env:
  NODE_VERSION: "25"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š DEPENDENCY ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  analyze-dependencies:
    name: ğŸ“Š Dependency Analysis
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check-updates.outputs.has-updates }}
      security-updates: ${{ steps.check-security.outputs.count }}
      update-summary: ${{ steps.generate-summary.outputs.summary }}

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ” Check for Updates
        id: check-updates
        run: |
          echo "Checking for available updates..."

          # Use our custom dependency manager
          UPDATE_RESULT=$(npm run deps:check)
          echo "$UPDATE_RESULT"

          # Check if updates are available
          if echo "$UPDATE_RESULT" | grep -q "Updates available"; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ›¡ï¸ Security Audit
        id: check-security
        run: |
          AUDIT_RESULT=$(npm audit --json || true)
          VULNERABILITY_COUNT=$(echo "$AUDIT_RESULT" | jq -r '.metadata.vulnerabilities.total // 0')
          echo "count=$VULNERABILITY_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULNERABILITY_COUNT" -gt 0 ]; then
            echo "ğŸš¨ Found $VULNERABILITY_COUNT security vulnerabilities"
          else
            echo "âœ… No security vulnerabilities found"
          fi

      - name: ğŸ“‹ Generate Update Summary
        id: generate-summary
        run: |
          echo "Generating dependency update summary..."

          SUMMARY="## ğŸ“Š Dependency Update Summary\n\n"
          SUMMARY="${SUMMARY}**Date:** $(date -u +%Y-%m-%d)\n"
          SUMMARY="${SUMMARY}**Security Issues:** ${{ steps.check-security.outputs.count }}\n"
          SUMMARY="${SUMMARY}**Update Type:** ${{ github.event.inputs.update_type || 'patch' }}\n\n"

          # Add outdated packages info
          OUTDATED=$(npm outdated --json || echo '{}')
          if [ "$OUTDATED" != "{}" ]; then
            SUMMARY="${SUMMARY}### ğŸ“¦ Outdated Packages\n\n"
            echo "$OUTDATED" | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> summary.tmp
            SUMMARY="${SUMMARY}$(cat summary.tmp)\n\n"
          fi

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”„ AUTOMATED UPDATES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  update-dependencies:
    name: ğŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    needs: analyze-dependencies
    if: needs.analyze-dependencies.outputs.has-updates == 'true' || needs.analyze-dependencies.outputs.security-updates != '0'

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ”„ Perform Updates
        run: |
          echo "Performing dependency updates..."

          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"

          case $UPDATE_TYPE in
            "security")
              echo "Applying security updates only..."
              npm audit fix --force
              ;;
            "patch")
              echo "Applying patch updates..."
              npm update --save --save-exact
              ;;
            "minor")
              echo "Applying minor updates..."
              npx npm-check-updates -u --target minor
              npm install
              ;;
            "major")
              echo "âš ï¸ Applying major updates (proceed with caution)..."
              npx npm-check-updates -u
              npm install
              ;;
            "all")
              echo "Applying all available updates..."
              npm audit fix --force
              npx npm-check-updates -u
              npm install
              ;;
          esac

      - name: ğŸ§ª Run Tests After Updates
        run: |
          echo "Running tests to verify updates..."
          npm run build
          npm test
          npm run test:memory

      - name: ğŸ“Š Generate Update Report
        run: |
          echo "Generating detailed update report..."

          # Create comprehensive update report
          cat > update-report.md << EOF
          # ğŸ“Š Dependency Update Report

          **Date:** $(date -u +%Y-%m-%d)
          **Update Type:** ${{ github.event.inputs.update_type || 'patch' }}
          **Trigger:** ${{ github.event_name }}

          ## ğŸ“ˆ Summary

          ${{ needs.analyze-dependencies.outputs.update-summary }}

          ## ğŸ§ª Test Results

          âœ… **Build:** Successful
          âœ… **Unit Tests:** Passed
          âœ… **Memory Tests:** Passed

          ## ğŸ“‹ Changed Files

          \`\`\`
          $(git diff --name-only)
          \`\`\`

          ## ğŸ” Package Changes

          \`\`\`json
          $(git diff package.json || echo "No package.json changes")
          \`\`\`

          ---

          *Automatically generated by GitHub Actions*
          EOF

      - name: ğŸ’¾ Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [Dependencies]"

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ”„ chore(deps): automated dependency updates

            - Update type: ${{ github.event.inputs.update_type || 'patch' }}
            - Security fixes: ${{ needs.analyze-dependencies.outputs.security-updates }}
            - Trigger: ${{ github.event_name }}

            All tests passing âœ…"

            git push origin main
            echo "Changes committed and pushed successfully"
          else
            echo "No changes to commit"
          fi

      - name: ğŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        if: github.event_name == 'schedule'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”„ chore(deps): automated dependency updates

            - Update type: ${{ github.event.inputs.update_type || 'patch' }}
            - Security fixes: ${{ needs.analyze-dependencies.outputs.security-updates }}
          title: "ğŸ”„ Automated Dependency Updates"
          body-path: update-report.md
          branch: deps/auto-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            security

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš¨ SECURITY MONITORING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  security-monitoring:
    name: ğŸš¨ Security Monitoring
    runs-on: ubuntu-latest
    needs: analyze-dependencies
    if: needs.analyze-dependencies.outputs.security-updates != '0'

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ” Detailed Security Analysis
        run: |
          echo "Performing detailed security analysis..."

          # Generate detailed security report
          npm audit --json > security-report.json || true

          # Parse and format security report
          cat security-report.json | jq -r '
            if .vulnerabilities then
              .vulnerabilities | to_entries[] |
              "ğŸš¨ **\(.key)**: \(.value.severity) - \(.value.title)"
            else
              "âœ… No vulnerabilities found"
            end
          ' > security-summary.txt

      - name: ğŸ“§ Log Security Alert
        run: |
          echo "ğŸš¨ Security Alert - ThreadTS Universal"
          echo "Vulnerabilities Found: ${{ needs.analyze-dependencies.outputs.security-updates }}"
          echo "Repository: ${{ github.repository }}"
          echo "Action Required: Review and apply security updates immediately"

      - name: ğŸ« Create Security Issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const securitySummary = fs.readFileSync('security-summary.txt', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Security Alert: ${context.payload.repository.security_updates} vulnerabilities found`,
              body: `## ğŸš¨ Automated Security Alert

              **Date:** ${new Date().toISOString()}
              **Vulnerabilities:** ${{ needs.analyze-dependencies.outputs.security-updates }}
              **Workflow:** ${{ github.workflow }}

              ## ğŸ“‹ Vulnerability Details

              ${securitySummary}

              ## ğŸ”§ Recommended Actions

              1. Review the vulnerabilities listed above
              2. Run \`npm audit fix\` to apply automatic fixes
              3. For manual fixes, update affected packages
              4. Run full test suite after applying fixes
              5. Monitor for additional security advisories

              ## ğŸ”— Resources

              - [Security Report](${context.payload.repository.html_url}/security/advisories)
              - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})

              ---

              *This issue was automatically created by GitHub Actions*`,
              labels: ['security', 'high-priority', 'automated']
            });

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ WORKFLOW SUMMARY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# This workflow provides:
# âœ… Weekly automated dependency scanning
# âœ… Security vulnerability monitoring
# âœ… Intelligent update categorization (patch/minor/major)
# âœ… Automated testing after updates
# âœ… Pull request creation for review
# âœ… Security team notifications
# âœ… Automated issue creation for security alerts
# âœ… Comprehensive update reporting
