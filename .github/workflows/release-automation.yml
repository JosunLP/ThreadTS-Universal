name: ğŸš€ Release Automation

# Triggered by pushing a tag like v1.0.0, v1.2.3-beta.0, etc.
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-*"

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "24"
  REGISTRY_URL: "https://registry.npmjs.org"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” VALIDATE & BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  validate:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          # Get version from tag (remove 'v' prefix)
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Release version: $VERSION"

          # Check if prerelease (contains hyphen like 1.0.0-beta.0)
          if [[ "$VERSION" == *-* ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ This is a prerelease"
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ This is a stable release"
          fi

      - name: âœ… Validate Tag matches package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.version }}"

          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   Tag version:     $TAG_VERSION"
            echo "   package.json:    $PACKAGE_VERSION"
            echo ""
            echo "ğŸ’¡ Fix: Update package.json version to $TAG_VERSION before tagging"
            exit 1
          fi

          echo "âœ… Version validated: $TAG_VERSION"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: ${{ env.REGISTRY_URL }}

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ§ª Run Tests
        run: npm run test

      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level=high || echo "âš ï¸ Security issues found (non-blocking)"

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ PUBLISH TO NPM
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  publish:
    name: ğŸ“¦ Publish to NPM
    runs-on: ubuntu-latest
    needs: validate
    environment: production

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: ${{ env.REGISTRY_URL }}

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸ“¦ Pack Package
        run: |
          npm pack
          echo "ğŸ“‹ Package contents:"
          tar -tzf threadts-universal-*.tgz | head -30

      - name: ğŸ§ª Test Package Installation
        run: |
          mkdir -p /tmp/install-test
          cd /tmp/install-test
          npm init -y

          npm install "$GITHUB_WORKSPACE"/threadts-universal-*.tgz

          # Test ESM import
          cat > test.mjs << 'EOF'
          import threadts from 'threadts-universal';
          console.log('âœ… ESM import successful');
          EOF
          node test.mjs

          # Test CJS require
          cat > test.cjs << 'EOF'
          const threadts = require('threadts-universal');
          console.log('âœ… CJS require successful');
          EOF
          node test.cjs

      - name: ğŸ“¤ Publish to NPM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ "${{ needs.validate.outputs.is-prerelease }}" = "true" ]; then
            # Extract prerelease identifier (e.g., "beta" from "1.0.0-beta.0")
            VERSION="${{ needs.validate.outputs.version }}"
            PREID=$(echo "$VERSION" | sed -n 's/.*-\([a-z]*\).*/\1/p')
            npm publish --tag "${PREID:-next}" --provenance --access public
          else
            npm publish --provenance --access public
          fi
          echo "âœ… Published threadts-universal@${{ needs.validate.outputs.version }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ‰ CREATE GITHUB RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  github-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, publish]

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Generate Release Notes
        id: notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Find previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -2 | tail -1)

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "v$VERSION" ]; then
            COMPARE_REF=$(git rev-list --max-parents=0 HEAD | head -1)
          else
            COMPARE_REF="$PREV_TAG"
          fi

          {
            echo "## What's Changed"
            echo ""

            # Features
            FEATURES=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="^feat" 2>/dev/null | head -10)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi

            # Fixes
            FIXES=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="^fix" 2>/dev/null | head -10)
            if [ -n "$FIXES" ]; then
              echo "### ğŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # If no conventional commits, show recent commits
            if [ -z "$FEATURES" ] && [ -z "$FIXES" ]; then
              echo "### ğŸ“ Changes"
              git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" 2>/dev/null | head -15
              echo ""
            fi

            echo ""
            echo "---"
            echo "ğŸ“¦ **NPM:** \`npm install threadts-universal@$VERSION\`"
          } > release-notes.md

          cat release-notes.md

      - name: ğŸ“¦ Download Build for Release
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸ“¦ Create Package Tarball
        run: npm pack

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: ThreadTS Universal v${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is-prerelease }}
          generate_release_notes: true
          files: |
            threadts-universal-*.tgz

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¢ POST-RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  post-release:
    name: ğŸ“¢ Release Complete
    runs-on: ubuntu-latest
    needs: [validate, publish, github-release]
    if: always() && needs.publish.result == 'success'

    steps:
      - name: ğŸ¯ Release Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ RELEASE SUCCESSFUL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Package: threadts-universal@${{ needs.validate.outputs.version }}"
          echo ""
          echo "ğŸ”— Links:"
          echo "  NPM:     https://npmjs.com/package/threadts-universal"
          echo "  GitHub:  https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate.outputs.version }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
