name: ğŸš€ Release Automation

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      prerelease_identifier:
        description: "Prerelease identifier (alpha, beta, rc)"
        required: false
        default: "beta"
        type: choice
        options:
          - alpha
          - beta
          - rc
      skip_tests:
        description: "Skip test suite (not recommended)"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Dry run (no actual release)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "24"
  REGISTRY_URL: "https://registry.npmjs.org"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” PRE-RELEASE VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  pre-release-validation:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.version-info.outputs.current }}
      next-version: ${{ steps.version-info.outputs.next }}
      has-changelog: ${{ steps.changelog.outputs.exists }}

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: ${{ env.REGISTRY_URL }}

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ“Š Version Information
        id: version-info
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Calculate next version without modifying package.json
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [ "$RELEASE_TYPE" = "prerelease" ]; then
            IDENTIFIER="${{ github.event.inputs.prerelease_identifier }}"
            NEXT_VERSION=$(npx semver "$CURRENT_VERSION" -i prerelease --preid "$IDENTIFIER")
          else
            NEXT_VERSION=$(npx semver "$CURRENT_VERSION" -i "$RELEASE_TYPE")
          fi

          echo "next=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Version bump: $CURRENT_VERSION â†’ $NEXT_VERSION"

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ§ª Run Test Suite
        if: inputs.skip_tests != true
        run: |
          echo "Running test suite..."
          npm run test

      - name: ğŸ”’ Security Audit
        run: |
          echo "Running security audit..."
          npm audit --audit-level=high || echo "âš ï¸ Security audit found issues (non-blocking)"

      - name: ğŸ“‹ Check Changelog
        id: changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ No CHANGELOG.md found, will create one"
          fi

      - name: ğŸ“‹ Generate Changelog Entry
        run: |
          CURRENT_VERSION="${{ steps.version-info.outputs.current }}"
          NEXT_VERSION="${{ steps.version-info.outputs.next }}"

          # Check if a tag for the current version exists
          if git rev-parse "v$CURRENT_VERSION" >/dev/null 2>&1; then
            COMPARE_REF="v$CURRENT_VERSION"
          else
            # Fall back to first commit or recent commits
            COMPARE_REF=$(git rev-list --max-parents=0 HEAD | head -1)
          fi

          cat > changelog-entry.md << EOF
          ## v$NEXT_VERSION ($(date -u +%Y-%m-%d))

          **Release Type:** ${{ github.event.inputs.release_type }}

          ### Changes

          EOF

          # Features
          FEATURES=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="^feat" 2>/dev/null | head -10)
          if [ -n "$FEATURES" ]; then
            echo "#### âœ¨ Features" >> changelog-entry.md
            echo "$FEATURES" >> changelog-entry.md
            echo "" >> changelog-entry.md
          fi

          # Fixes
          FIXES=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="^fix" 2>/dev/null | head -10)
          if [ -n "$FIXES" ]; then
            echo "#### ğŸ› Bug Fixes" >> changelog-entry.md
            echo "$FIXES" >> changelog-entry.md
            echo "" >> changelog-entry.md
          fi

          # Performance
          PERF=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="^perf" 2>/dev/null | head -5)
          if [ -n "$PERF" ]; then
            echo "#### âš¡ Performance" >> changelog-entry.md
            echo "$PERF" >> changelog-entry.md
            echo "" >> changelog-entry.md
          fi

          # Breaking Changes
          BREAKING=$(git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" --grep="BREAKING" 2>/dev/null | head -5)
          if [ -n "$BREAKING" ]; then
            echo "#### ğŸ’¥ Breaking Changes" >> changelog-entry.md
            echo "$BREAKING" >> changelog-entry.md
            echo "" >> changelog-entry.md
          fi

          # If no conventional commits found, list recent commits
          if [ -z "$FEATURES" ] && [ -z "$FIXES" ] && [ -z "$PERF" ]; then
            echo "#### ğŸ“ Recent Changes" >> changelog-entry.md
            git log "$COMPARE_REF"..HEAD --pretty=format:"- %s" 2>/dev/null | head -15 >> changelog-entry.md
            echo "" >> changelog-entry.md
          fi

          cat changelog-entry.md

      - name: ğŸ“¤ Upload Pre-Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-artifacts
          path: |
            changelog-entry.md
            dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¯ RELEASE EXECUTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  execute-release:
    name: ğŸ¯ Execute Release
    runs-on: ubuntu-latest
    needs: pre-release-validation
    if: inputs.dry_run != true
    environment: production

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: ${{ env.REGISTRY_URL }}

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ“¥ Download Pre-Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pre-release-artifacts
          path: artifacts/

      - name: ğŸ”§ Configure Git
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: ğŸ“ˆ Version Bump
        id: version-bump
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [ "$RELEASE_TYPE" = "prerelease" ]; then
            IDENTIFIER="${{ github.event.inputs.prerelease_identifier }}"
            NEW_VERSION=$(npm version prerelease --preid="$IDENTIFIER" --no-git-tag-version)
          else
            NEW_VERSION=$(npm version "$RELEASE_TYPE" --no-git-tag-version)
          fi

          # Remove 'v' prefix for consistency
          NEW_VERSION="${NEW_VERSION#v}"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Version bumped to: $NEW_VERSION"

      - name: ğŸ“‹ Update Changelog
        run: |
          NEW_VERSION="${{ steps.version-bump.outputs.version }}"

          if [ -f "CHANGELOG.md" ]; then
            # Prepend new changelog entry
            {
              echo "# Changelog"
              echo ""
              cat artifacts/changelog-entry.md
              echo ""
              # Skip the first line (# Changelog) of existing file
              tail -n +2 CHANGELOG.md
            } > CHANGELOG.md.new
            mv CHANGELOG.md.new CHANGELOG.md
          else
            # Create new changelog
            {
              echo "# Changelog"
              echo ""
              cat artifacts/changelog-entry.md
            } > CHANGELOG.md
          fi

      - name: ğŸ“ Commit Changes
        run: |
          NEW_VERSION="${{ steps.version-bump.outputs.version }}"
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore(release): v$NEW_VERSION"

      - name: ğŸ·ï¸ Create Git Tag
        run: |
          NEW_VERSION="${{ steps.version-bump.outputs.version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"

      - name: ğŸ“¦ Pack and Verify Package
        run: |
          npm pack
          echo "ğŸ“‹ Package contents:"
          tar -tzf threadts-universal-*.tgz | head -30

      - name: ğŸ§ª Test Package Installation
        run: |
          mkdir -p /tmp/install-test
          cd /tmp/install-test
          npm init -y

          # Install the packed package
          npm install "$GITHUB_WORKSPACE"/threadts-universal-*.tgz

          # Test import
          cat > test.mjs << 'EOF'
          import threadts from 'threadts-universal';
          console.log('âœ… ESM import successful');
          console.log('ThreadTS type:', typeof threadts);
          EOF

          node test.mjs

          # Test require
          cat > test.cjs << 'EOF'
          const threadts = require('threadts-universal');
          console.log('âœ… CJS require successful');
          console.log('ThreadTS type:', typeof threadts);
          EOF

          node test.cjs

      - name: ğŸ“¤ Publish to NPM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [ "$RELEASE_TYPE" = "prerelease" ]; then
            npm publish --tag "${{ github.event.inputs.prerelease_identifier }}" --provenance --access public
          else
            npm publish --provenance --access public
          fi

          echo "âœ… Package published successfully"

      - name: ğŸ“¤ Push Changes
        run: |
          git push origin HEAD
          git push origin "v${{ steps.version-bump.outputs.version }}"

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version-bump.outputs.version }}
          name: ThreadTS Universal v${{ steps.version-bump.outputs.version }}
          body_path: artifacts/changelog-entry.md
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          generate_release_notes: true
          files: |
            threadts-universal-*.tgz

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š DRY RUN SIMULATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  dry-run-simulation:
    name: ğŸ“Š Dry Run Simulation
    runs-on: ubuntu-latest
    needs: pre-release-validation
    if: inputs.dry_run == true

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ“¥ Download Pre-Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pre-release-artifacts
          path: artifacts/

      - name: ğŸ“Š Dry Run Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ DRY RUN SIMULATION REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Release Information:"
          echo "  Current Version: ${{ needs.pre-release-validation.outputs.current-version }}"
          echo "  Next Version:    ${{ needs.pre-release-validation.outputs.next-version }}"
          echo "  Release Type:    ${{ github.event.inputs.release_type }}"
          if [ "${{ github.event.inputs.release_type }}" = "prerelease" ]; then
            echo "  Prerelease ID:   ${{ github.event.inputs.prerelease_identifier }}"
          fi
          echo ""
          echo "ğŸ”§ Actions that would be performed:"
          echo "  1. âœ… Version bump in package.json"
          echo "  2. âœ… Update/create CHANGELOG.md"
          echo "  3. âœ… Commit changes"
          echo "  4. âœ… Create git tag: v${{ needs.pre-release-validation.outputs.next-version }}"
          echo "  5. âœ… Build and pack npm package"
          echo "  6. âœ… Publish to NPM registry"
          echo "  7. âœ… Push changes to GitHub"
          echo "  8. âœ… Create GitHub release"
          echo ""
          echo "ğŸ“¦ Package Analysis:"
          npm pack --dry-run 2>&1 | tail -30
          echo ""
          echo "ğŸ“‹ Changelog Entry Preview:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat artifacts/changelog-entry.md
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ¯ To execute this release, re-run with dry_run=false"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¢ POST-RELEASE NOTIFICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  post-release:
    name: ğŸ“¢ Post-Release
    runs-on: ubuntu-latest
    needs: [pre-release-validation, execute-release]
    if: always() && needs.execute-release.result == 'success'

    steps:
      - name: ğŸ¯ Release Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ RELEASE SUCCESSFUL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Package: threadts-universal@${{ needs.pre-release-validation.outputs.next-version }}"
          echo ""
          echo "ğŸ”— Links:"
          echo "  NPM:     https://npmjs.com/package/threadts-universal"
          echo "  GitHub:  https://github.com/${{ github.repository }}/releases/tag/v${{ needs.pre-release-validation.outputs.next-version }}"
          echo ""
          echo "ğŸ“Š Release Details:"
          echo "  Previous: ${{ needs.pre-release-validation.outputs.current-version }}"
          echo "  New:      ${{ needs.pre-release-validation.outputs.next-version }}"
          echo "  Type:     ${{ github.event.inputs.release_type }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
